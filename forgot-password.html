<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Forgot Password - ISDN System</title>
    <script>
      // Override alert IMMEDIATELY to suppress language fetching errors
      const _originalAlert = window.alert;
      window.alert = function (msg) {
        if (msg && (msg.includes("Error fetching languages") || msg.includes("language"))) {
          return; // Suppress silently
        }
        _originalAlert(msg);
      };
    </script>
    <link rel="stylesheet" href="css/styles.css" />
    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      .form-container {
        max-width: 400px;
        margin: 100px auto;
        background: white;
        padding: 40px;
        border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      }
      .form-title {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
      }
      .success-message {
        background: #d4edda;
        color: #155724;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 20px;
        display: none;
      }
      .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 20px;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="form-container">
      <h2 class="form-title">üîê Reset Password</h2>

      <div class="success-message" id="success-msg">
        ‚úì Password reset instructions sent to your email
      </div>
      <div class="error-message" id="error-msg"></div>

      <form id="forgot-form" class="display-none">
        <div class="form-group">
          <label>Email Address:</label>
          <input
            type="email"
            id="email"
            placeholder="Enter your email"
            required
          />
        </div>
        <button type="submit" class="btn btn-primary width-100 margin-top-20">
          Send Reset Link
        </button>
        <p class="text-center margin-top-15">
          <a href="index.html" class="text-color-primary text-decoration-none"
            >Back to Login</a
          >
        </p>
      </form>

      <form id="reset-form" class="display-none">
        <!-- Hidden username field for accessibility -->
        <input
          type="hidden"
          id="reset-username"
          name="username"
          autocomplete="username"
        />
        <div class="form-group">
          <label>New Password:</label>
          <input
            type="password"
            id="new-password"
            placeholder="Enter new password"
            autocomplete="new-password"
            required
          />
        </div>
        <div class="form-group">
          <label>Confirm Password:</label>
          <input
            type="password"
            id="confirm-password"
            placeholder="Confirm password"
            required
          />
        </div>
        <button type="submit" class="btn btn-primary width-100 margin-top-20">
          Reset Password
        </button>
      </form>
    </div>

    <script src="js/data.js"></script>
    <script src="js/auth.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get("token");

        if (token) {
          document.getElementById("reset-form").style.display = "block";
          document
            .getElementById("reset-form")
            .addEventListener("submit", function (e) {
              e.preventDefault();

              // Find user and populate hidden username field
              const user = systemData.users.find((u) => u.resetToken === token);
              if (user) {
                const usernameField = document.getElementById("reset-username");
                if (usernameField) {
                  usernameField.value = user.email || user.username || "";
                }
              }

              const pwd1 = document.getElementById("new-password").value;
              const pwd2 = document.getElementById("confirm-password").value;

              if (pwd1 !== pwd2) {
                showError("Passwords do not match");
                return;
              }

              if (pwd1.length < 6) {
                showError("Password must be at least 6 characters");
                return;
              }

              const user = systemData.users.find((u) => u.resetToken === token);
              if (user) {
                user.password = pwd1;
                delete user.resetToken;
                saveData();
                document.getElementById("success-msg").textContent =
                  "‚úì Password reset successfully. Redirecting...";
                document.getElementById("success-msg").style.display = "block";
                setTimeout(() => (window.location.href = "index.html"), 2000);
              } else {
                showError("Invalid reset token");
              }
            });
        } else {
          document.getElementById("forgot-form").style.display = "block";
          document
            .getElementById("forgot-form")
            .addEventListener("submit", function (e) {
              e.preventDefault();
              const email = document.getElementById("email").value;
              const user = systemData.users.find((u) => u.email === email);

              if (!user) {
                showError("Email not found in system");
                return;
              }

              user.resetToken = Math.random().toString(36).substr(2, 9);
              saveData();

              document.getElementById("forgot-form").style.display = "none";
              document.getElementById("success-msg").textContent =
                `‚úì Reset link sent to ${email}. Token: ${user.resetToken}`;
              document.getElementById("success-msg").style.display = "block";
            });
        }

        function showError(msg) {
          const el = document.getElementById("error-msg");
          el.textContent = "‚úó " + msg;
          el.style.display = "block";
        }
      });
    </script>
  </body>
</html>
