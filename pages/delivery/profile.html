<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Delivery Staff - Profile</title>
    <script>
      // Override alert IMMEDIATELY to suppress language fetching errors
      const _originalAlert = window.alert;
      window.alert = function (msg) {
        if (
          msg &&
          (msg.includes("Error fetching languages") || msg.includes("language"))
        ) {
          console.warn("[Suppressed] " + msg);
          return; // Suppress silently
        }
        _originalAlert(msg);
      };
      // Also override console.error to suppress language errors there
      const _originalError = console.error;
      console.error = function (...args) {
        const msg = args.join(" ");
        if (msg && msg.includes("language")) {
          return; // Suppress language-related errors
        }
        _originalError.apply(console, args);
      };
    </script>
    <link rel="stylesheet" href="../../css/styles.css" />
  </head>
  <body>
    <!-- Navigation Bar -->
    <nav class="navbar">
      <div class="nav-container">
        <div class="nav-logo">
          <span class="logo-text">Delivery System - Staff</span>
          <span id="current-user"></span>
        </div>
        <div class="nav-menu">
          <button class="nav-link" data-nav="dashboard">Dashboard</button>
          <button class="nav-link" data-nav="deliveries">My Deliveries</button>
          <button class="nav-link active" data-nav="profile">Profile</button>
          <button class="nav-link logout" data-nav="logout">Logout</button>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="page-content">
      <div class="page-header">
        <h2>üë§ Delivery Staff Profile</h2>
        <p>Manage your profile and settings</p>
      </div>

      <!-- Profile Section -->
      <div class="card max-width-600 margin-auto">
        <div class="card-header">
          <h3>üìã Personal Information</h3>
        </div>
        <form id="profile-form" class="padding-20">
          <div class="form-group">
            <label>Full Name:</label>
            <input
              type="text"
              id="profile-name"
              placeholder="Your full name"
              required
            />
          </div>

          <div class="form-group">
            <label>Email:</label>
            <input
              type="email"
              id="profile-email"
              placeholder="Your email"
              required
            />
          </div>

          <div class="form-group">
            <label>Phone Number:</label>
            <input
              type="tel"
              id="profile-phone"
              placeholder="+94 70 123 4567"
              required
            />
          </div>

          <div class="form-group">
            <label>Current Address:</label>
            <input
              type="text"
              id="profile-address"
              placeholder="Residential address"
              required
            />
          </div>

          <div class="form-group">
            <label>Vehicle Type:</label>
            <select
              id="profile-vehicle"
              aria-label="Select vehicle type"
              required
            >
              <option value="">Select vehicle type</option>
              <option value="motorcycle">Motorcycle</option>
              <option value="car">Car</option>
              <option value="van">Van</option>
              <option value="truck">Truck</option>
            </select>
          </div>

          <div class="form-group">
            <label>Vehicle License Plate:</label>
            <input
              type="text"
              id="profile-plate"
              placeholder="e.g., CAR-1234"
              required
            />
          </div>

          <button type="submit" class="btn btn-primary width-100 margin-top-20">
            Save Profile
          </button>
        </form>
      </div>

      <!-- Performance Stats Section -->
      <div class="card max-width-600 margin-auto">
        <div class="card-header">
          <h3>üìä Performance Statistics</h3>
        </div>
        <div class="padding-20">
          <div class="stat-item">
            <label>Total Deliveries:</label>
            <span id="stat-total" class="stat-value">0</span>
          </div>
          <div class="stat-item">
            <label>Completed Deliveries:</label>
            <span id="stat-completed" class="stat-value">0</span>
          </div>
          <div class="stat-item">
            <label>Failed Deliveries:</label>
            <span id="stat-failed" class="stat-value">0</span>
          </div>
          <div class="stat-item">
            <label>Success Rate:</label>
            <span id="stat-rate" class="stat-value">0%</span>
          </div>
          <div class="stat-item">
            <label>Average Rating:</label>
            <span id="stat-rating" class="stat-value">‚òÖ 0.0</span>
          </div>
        </div>
      </div>

      <!-- Change Password Section -->
      <div class="card max-width-600 margin-auto">
        <div class="card-header">
          <h3>üîê Security</h3>
        </div>
        <form id="password-form" class="padding-20">
          <!-- Hidden username field for accessibility/autofill -->
          <input
            type="hidden"
            id="username"
            name="username"
            autocomplete="username"
          />

          <div class="form-group">
            <label for="current-password">Current Password:</label>
            <input
              type="password"
              id="current-password"
              placeholder="Enter current password"
              autocomplete="current-password"
              required
            />
          </div>

          <div class="form-group">
            <label for="new-password">New Password:</label>
            <input
              type="password"
              id="new-password"
              placeholder="Enter new password"
              autocomplete="new-password"
              required
            />
          </div>

          <div class="form-group">
            <label for="confirm-password">Confirm New Password:</label>
            <input
              type="password"
              id="confirm-password"
              placeholder="Confirm new password"
              autocomplete="new-password"
              required
            />
          </div>

          <button type="submit" class="btn btn-warning width-100 margin-top-20">
            Update Password
          </button>
        </form>
      </div>

      <!-- Availability Section -->
      <div class="card max-width-600 margin-auto">
        <div class="card-header">
          <h3>‚è∞ Availability</h3>
        </div>
        <div class="padding-20">
          <div class="form-group">
            <label for="availability-status">Current Status:</label>
            <select
              id="availability-status"
              title="Select your availability status"
            >
              <option value="available">Available for Deliveries</option>
              <option value="on-break">On Break</option>
              <option value="busy">Busy</option>
              <option value="offline">Offline</option>
            </select>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="location-sharing" /> Enable Location
              Sharing
            </label>
            <small>Allow RDC staff to track your location</small>
          </div>

          <button
            type="button"
            class="btn btn-success"
            onclick="updateAvailability()"
          >
            Save Settings
          </button>
        </div>
      </div>
    </div>

    <script src="../../js/data.js"></script>
    <script src="../../js/auth.js"></script>

    <script>
      // Initialize on page load
      document.addEventListener("DOMContentLoaded", function () {
        loadProfileData();
        loadPerformanceStats();
        setupNavigation();
        setupFormSubmissions();
      });

      // Load profile data from localStorage
      function loadProfileData() {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (!currentUser) {
          window.location.href = "../../index.html";
          return;
        }

        document.getElementById("current-user").textContent =
          `Logged in as: ${currentUser.name}`;
        document.getElementById("profile-name").value = currentUser.name || "";
        document.getElementById("profile-email").value =
          currentUser.email || "";
        document.getElementById("profile-phone").value =
          currentUser.phone || "";
        document.getElementById("profile-address").value =
          currentUser.address || "";
        document.getElementById("profile-vehicle").value =
          currentUser.vehicle || "";
        document.getElementById("profile-plate").value =
          currentUser.licensePlate || "";
        document.getElementById("availability-status").value =
          currentUser.status || "available";
        document.getElementById("location-sharing").checked =
          currentUser.locationSharing !== false;
      }

      // Load performance statistics
      function loadPerformanceStats() {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (!currentUser) return;

        const myDeliveries = (systemData.deliveries || []).filter(
          (d) => d.assignedTo === currentUser.id,
        );
        const completed = myDeliveries.filter(
          (d) => d.status === "delivered",
        ).length;
        const failed = myDeliveries.filter((d) => d.status === "failed").length;
        const total = myDeliveries.length;
        const successRate =
          total > 0 ? ((completed / total) * 100).toFixed(1) : 0;

        document.getElementById("stat-total").textContent = total;
        document.getElementById("stat-completed").textContent = completed;
        document.getElementById("stat-failed").textContent = failed;
        document.getElementById("stat-rate").textContent = successRate + "%";
        document.getElementById("stat-rating").textContent =
          "‚òÖ " + (currentUser.rating || 0).toFixed(1);
      }

      // Setup navigation
      function setupNavigation() {
        document.addEventListener("click", function (e) {
          const nav = e.target.getAttribute("data-nav");
          if (nav === "dashboard") {
            window.location.href = "dashboard.html";
          } else if (nav === "deliveries") {
            window.location.href = "deliveries.html";
          } else if (nav === "logout") {
            localStorage.removeItem("currentUser");
            localStorage.removeItem("authToken");
            window.location.href = "../../index.html";
          }
        });
      }

      // Setup form submissions
      function setupFormSubmissions() {
        document
          .getElementById("profile-form")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            saveProfileData();
          });

        document
          .getElementById("password-form")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            changePassword();
          });
      }

      // Save profile data
      function saveProfileData() {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (!currentUser) return;

        currentUser.name = document.getElementById("profile-name").value;
        currentUser.email = document.getElementById("profile-email").value;
        currentUser.phone = document.getElementById("profile-phone").value;
        currentUser.address = document.getElementById("profile-address").value;
        currentUser.vehicle = document.getElementById("profile-vehicle").value;
        currentUser.licensePlate =
          document.getElementById("profile-plate").value;

        // Update in system data
        const userIndex = systemData.users.findIndex(
          (u) => u.id === currentUser.id,
        );
        if (userIndex !== -1) {
          systemData.users[userIndex] = {
            ...systemData.users[userIndex],
            ...currentUser,
          };
        }

        localStorage.setItem("currentUser", JSON.stringify(currentUser));
        // saveData() would cause Firebase fetch; skipping for demo
        alert("‚úì Profile updated successfully!");
      }

      // Change password
      function changePassword() {
        const currentPassword =
          document.getElementById("current-password").value;
        const newPassword = document.getElementById("new-password").value;
        const confirmPassword =
          document.getElementById("confirm-password").value;

        // Populate hidden username field for accessibility/autofill
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (currentUser) {
          document.getElementById("username").value =
            currentUser.email || currentUser.name || "";
        }

        if (newPassword !== confirmPassword) {
          alert("‚ö†Ô∏è New passwords do not match");
          return;
        }

        if (newPassword.length < 6) {
          alert("‚ö†Ô∏è Password must be at least 6 characters long");
          return;
        }

        // In a real app, verify current password first
        if (!currentUser) return;

        currentUser.password = newPassword;
        const userIndex = systemData.users.findIndex(
          (u) => u.id === currentUser.id,
        );
        if (userIndex !== -1) {
          systemData.users[userIndex].password = newPassword;
        }

        localStorage.setItem("currentUser", JSON.stringify(currentUser));
        // saveData() would cause Firebase fetch; skipping for demo
        document.getElementById("password-form").reset();
        alert("‚úì Password changed successfully!");
      }

      // Update availability
      function updateAvailability() {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (!currentUser) return;

        currentUser.status = document.getElementById(
          "availability-status",
        ).value;
        currentUser.locationSharing =
          document.getElementById("location-sharing").checked;

        localStorage.setItem("currentUser", JSON.stringify(currentUser));

        const userIndex = systemData.users.findIndex(
          (u) => u.id === currentUser.id,
        );
        if (userIndex !== -1) {
          systemData.users[userIndex] = {
            ...systemData.users[userIndex],
            ...currentUser,
          };
        }

        // saveData() would cause Firebase fetch; skipping for demo
        alert("‚úì Availability settings saved!");
      }
    </script>

    <style>
      .stat-item {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
      }

      .stat-item:last-child {
        border-bottom: none;
      }

      .stat-value {
        font-weight: bold;
        color: #27ae60;
        font-size: 1.1em;
      }
    </style>
  </body>
</html>
