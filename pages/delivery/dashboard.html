<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Delivery Staff - Dashboard</title>
    <link rel="stylesheet" href="../../css/styles.css" />
    <link rel="stylesheet" href="../../css/footer.css" />
    <link rel="stylesheet" href="../../css/images.css" />
  </head>
  <body>
    <!-- Navigation Bar -->
    <nav class="navbar">
      <div class="nav-container">
        <div class="nav-logo">
          <span class="logo-text">Delivery System - Staff</span>
          <span id="current-user"></span>
        </div>
        <div class="nav-menu">
          <button class="nav-link active" data-nav="dashboard">
            Dashboard
          </button>
          <button class="nav-link" data-nav="deliveries">My Deliveries</button>
          <button class="nav-link" data-nav="profile">Profile</button>
          <button class="nav-link logout" data-nav="logout">Logout</button>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="page-content">
      <div class="page-header">
        <h2>üöö Delivery Staff Dashboard</h2>
        <p>Manage your assigned deliveries and track routes</p>
      </div>

      <!-- Dashboard Stats -->
      <div class="dashboard-stats">
        <div class="stat-card">
          <h3>üì¨ Assigned Deliveries</h3>
          <p id="total-assigned">0</p>
          <small>Today's deliveries</small>
        </div>
        <div class="stat-card">
          <h3>‚úÖ Completed</h3>
          <p id="total-completed">0</p>
          <small>Successfully delivered</small>
        </div>
        <div class="stat-card">
          <h3>üöó In Transit</h3>
          <p id="total-in-transit">0</p>
          <small>Currently out for delivery</small>
        </div>
        <div class="stat-card">
          <h3>‚ö†Ô∏è Failed</h3>
          <p id="total-failed">0</p>
          <small>Delivery failed</small>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <h3>Quick Actions</h3>
        <div class="action-grid">
          <button
            class="action-btn"
            onclick="window.location.href = 'deliveries.html'"
          >
            <span class="action-icon">üìã</span>
            <span>View My Deliveries</span>
          </button>
          <button class="action-btn" onclick="viewAssignedDeliveries()">
            <span class="action-icon">üìç</span>
            <span>View on Map</span>
          </button>
          <button class="action-btn" onclick="updateDeliveryStatus()">
            <span class="action-icon">‚úèÔ∏è</span>
            <span>Update Status</span>
          </button>
        </div>
      </div>

      <!-- Today's Deliveries Summary -->
      <div class="section">
        <h3>Today's Assigned Deliveries</h3>
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Delivery ID</th>
                <th>Order ID</th>
                <th>Customer</th>
                <th>Location</th>
                <th>Status</th>
                <th>ETA</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="delivery-staff-table">
              <tr>
                <td colspan="7" class="text-center padding-20 color-999">
                  Loading deliveries...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Delivery Status Legend -->
      <div class="info-box">
        <h4>Delivery Status Guide</h4>
        <div class="grid-auto-fit margin-top-10">
          <div>
            <span class="status-badge status-assigned">Assigned</span> -
            Delivery assigned to you
          </div>
          <div>
            <span class="status-badge status-out">Out for Delivery</span> -
            Currently en route
          </div>
          <div>
            <span class="status-badge status-delivered">Delivered</span> -
            Successfully completed
          </div>
          <div>
            <span class="status-badge status-failed">Failed</span> - Could not
            deliver
          </div>
        </div>
      </div>
    </div>

    <!-- Modals -->
    <div id="delivery-details-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('delivery-details-modal')"
          >&times;</span
        >
        <h2>Delivery Details</h2>
        <div id="delivery-details-content" class="margin-top-20">
          <!-- Delivery details will be populated here -->
        </div>
      </div>
    </div>

    <script src="../../js/data.js"></script>
    <script src="../../js/modals.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../js/delivery.js"></script>

    <script>
      // Suppress language fetching errors from browser extensions or third-party scripts
      window.addEventListener("error", function (event) {
        if (
          event.message &&
          event.message.includes("Error fetching languages")
        ) {
          event.preventDefault();
          return true;
        }
      });
    </script>

    <script>
      // Initialize dashboard on page load
      document.addEventListener("DOMContentLoaded", function () {
        // Wait for systemData to be available
        (async () => {
          let attempts = 0;
          while (!window.systemData && attempts < 50) {
            await new Promise((resolve) => setTimeout(resolve, 100));
            attempts++;
          }
          if (window.systemData) {
            updateDeliveryStats();
            updateDeliveryStaffTable();
          } else {
            console.warn("systemData not loaded after timeout");
          }
        })();

        // Setup navigation
        document.addEventListener("click", function (e) {
          const nav = e.target.getAttribute("data-nav");
          if (nav === "deliveries") {
            window.location.href = "deliveries.html";
          } else if (nav === "profile") {
            window.location.href = "profile.html";
          } else if (nav === "dashboard") {
            window.location.href = "dashboard.html";
          }
        });
      });

      // Update dashboard stats
      function updateDeliveryStats() {
        if (!systemData || !systemData.deliveries) {
          console.warn("systemData.deliveries not available yet");
          return;
        }

        // Filter by currentUser ID if logged in, otherwise show all deliveries (demo mode)
        const userId = currentUser?.userID || 4; // Default to staff ID 4 for demo
        const assignedDeliveries = systemData.deliveries.filter(
          (d) =>
            d.assignedStaff === userId ||
            (d.assignedStaff !== null && !currentUser),
        );

        // Count by status
        const completed = assignedDeliveries.filter(
          (d) => d.status === "delivered",
        ).length;
        const inTransit = assignedDeliveries.filter(
          (d) => d.status === "out for delivery",
        ).length;
        const failed = assignedDeliveries.filter(
          (d) => d.status === "failed",
        ).length;

        // Update DOM with actual counts
        document.getElementById("total-assigned").textContent =
          assignedDeliveries.length;
        document.getElementById("total-completed").textContent = completed;
        document.getElementById("total-in-transit").textContent = inTransit;
        document.getElementById("total-failed").textContent = failed;

        console.log("Delivery stats updated:", {
          assigned: assignedDeliveries.length,
          completed,
          inTransit,
          failed,
        });
      }

      // Show delivery map view with assigned deliveries
      function viewAssignedDeliveries() {
        const userId = currentUser?.userID || 4;
        const assigned = systemData.deliveries.filter(
          (d) => d.assignedStaff === userId,
        );

        if (assigned.length === 0) {
          alert("No deliveries assigned to you.");
          return;
        }

        let mapContent = '<div style="padding: 20px;">';
        mapContent += "<h3>üó∫Ô∏è Your Assigned Deliveries Map</h3>";
        mapContent +=
          '<div style="background:#f0f0f0; padding:15px; border-radius:8px; margin-top:15px;">';
        mapContent += "<p><strong>üìç Delivery Locations:</strong></p>";

        assigned.forEach((delivery, idx) => {
          const order = systemData.orders.find(
            (o) => o.orderID === delivery.orderID,
          );
          const customer = systemData.users.find(
            (u) => u.userID === order?.userID,
          );
          mapContent += `<div style="margin:10px 0; padding:10px; background:white; border-left:4px solid #007bff;">`;
          mapContent += `<strong>#${delivery.deliveryID}</strong> - ${delivery.route}<br>`;
          mapContent += `Customer: ${customer?.name || "Unknown"}<br>`;
          mapContent += `ETA: ${delivery.estimatedTime}<br>`;
          mapContent += `Status: <span style="color: #27ae60; font-weight:bold;">${delivery.status}</span>`;
          mapContent += `</div>`;
        });

        mapContent += "</div></div>";

        const modal = document.getElementById("delivery-details-modal");
        document.getElementById("delivery-details-content").innerHTML =
          mapContent;
        modal.style.display = "block";
        modal.classList.add("active");
      }

      // Quick status update modal
      function updateDeliveryStatus() {
        const userId = currentUser?.userID || 4;
        const assigned = systemData.deliveries.filter(
          (d) => d.assignedStaff === userId,
        );

        if (assigned.length === 0) {
          alert("No deliveries assigned to you.");
          return;
        }

        let statusContent = '<div style="padding: 20px;">';
        statusContent += "<h3>‚úèÔ∏è Quick Status Update</h3>";
        statusContent +=
          '<p style="color:#666; margin-bottom:15px;">Select a delivery to update its status:</p>';

        assigned.forEach((delivery) => {
          const order = systemData.orders.find(
            (o) => o.orderID === delivery.orderID,
          );
          const customer = systemData.users.find(
            (u) => u.userID === order?.userID,
          );
          const statuses = [
            "assigned",
            "out for delivery",
            "delivered",
            "failed",
          ];
          const currentIdx = statuses.indexOf(delivery.status);
          const nextStatus = statuses[(currentIdx + 1) % statuses.length];

          statusContent += `<div style="margin:10px 0; padding:12px; background:#f9f9f9; border-radius:6px; display:flex; justify-content:space-between; align-items:center;">`;
          statusContent += `<div><strong>#${delivery.deliveryID}</strong> - ${customer?.name || "Unknown"}<br><small>Current: <span style="color:#27ae60;">${delivery.status}</span></small></div>`;
          statusContent += `<button class="btn btn-primary" style="padding:6px 12px; white-space:nowrap;" onclick="quickUpdateStatus(${delivery.deliveryID}, '${nextStatus}')">Update to ${nextStatus}</button>`;
          statusContent += `</div>`;
        });

        statusContent += "</div>";

        const modal = document.getElementById("delivery-details-modal");
        document.getElementById("delivery-details-content").innerHTML =
          statusContent;
        modal.style.display = "block";
        modal.classList.add("active");
      }

      // Quick update status helper
      function quickUpdateStatus(deliveryID, newStatus) {
        const delivery = systemData.deliveries.find(
          (d) => d.deliveryID === deliveryID,
        );
        if (delivery) {
          delivery.status = newStatus;
          if (newStatus === "delivered") {
            const order = systemData.orders.find(
              (o) => o.orderID === delivery.orderID,
            );
            if (order) order.status = "delivered";
          }
          updateDeliveryStats();
          updateDeliveryStatus(); // Refresh modal
          console.log(
            `Delivery #${deliveryID} status updated to "${newStatus}"`,
          );
        }
      }

      // Close modal helper
      function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.style.display = "none";
          modal.classList.remove("active");
        }
      }
    </script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

    <!-- Firebase Config & Initialization -->
    <script src="../../js/firebase-config.js"></script>
    <script>
      (async () => {
        window._FB_READY = await FirebaseHelper.init();
      })();
    </script>

    <!-- Footer Loader -->
    <script src="/js/footer-loader.js"></script>
  </body>
</html>
